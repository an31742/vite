<template>
  <h2>ä¸‹æ‹‰åˆ·æ–°</h2>
  <!-- 1. @touchstart="handleTouchStart"ï¼š
     â€¢ touchstart äº‹ä»¶ï¼šå½“ç”¨æˆ·æ‰‹æŒ‡é¦–æ¬¡æ¥è§¦å±å¹•æ—¶è§¦å‘ï¼Œç›¸å½“äºé¼ æ ‡çš„ mousedown äº‹ä»¶ã€‚è¿™ä¸ªäº‹ä»¶é€šå¸¸ç”¨äºè®°å½•è§¦æ‘¸å¼€å§‹æ—¶çš„ä½ç½®æˆ–æ—¶é—´ç­‰ä¿¡æ¯ã€‚
     â€¢ ç»‘å®šçš„å‡½æ•°ï¼šhandleTouchStartï¼šå½“ touchstart äº‹ä»¶è§¦å‘æ—¶ï¼ŒVue.js ä¼šè°ƒç”¨ handleTouchStart
    å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·æŒ‰ä¸‹å±å¹•æ—¶ï¼Œè¯¥å‡½æ•°å¯ä»¥ç”¨æ¥è®°å½•è§¦æ‘¸çš„åˆå§‹ä½ç½®ã€‚
    2. @touchmove="handleTouchMove"ï¼š
     â€¢ touchmove äº‹ä»¶ï¼šå½“ç”¨æˆ·æ‰‹æŒ‡åœ¨å±å¹•ä¸Šæ»‘åŠ¨æ—¶è§¦å‘ï¼Œç›¸å½“äºé¼ æ ‡çš„ mousemove äº‹ä»¶ã€‚åœ¨æ‰‹æŒ‡ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šè¿ç»­è§¦å‘ã€‚
     â€¢ ç»‘å®šçš„å‡½æ•°ï¼šhandleTouchMoveï¼šåœ¨ touchmove äº‹ä»¶è§¦å‘æ—¶ï¼Œè°ƒç”¨ handleTouchMove
    å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°é€šå¸¸ç”¨äºè®¡ç®—ç”¨æˆ·æ»‘åŠ¨çš„è·ç¦»æˆ–è€…è·Ÿè¸ªæ‰‹æŒ‡çš„ç§»åŠ¨è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹æ‹‰åˆ·æ–°ä¸­ï¼Œå®ƒç”¨äºè®¡ç®—æ‰‹æŒ‡çš„ç§»åŠ¨è·ç¦»ï¼Œä»¥è°ƒæ•´ä¸‹æ‹‰çš„è§†è§‰æ•ˆæœã€‚ 3. @touchend="handleTouchEnd"ï¼š â€¢ touchend äº‹ä»¶ï¼šå½“ç”¨æˆ·æ‰‹æŒ‡ç¦»å¼€å±å¹•æ—¶è§¦å‘ï¼Œç›¸å½“äºé¼ æ ‡çš„ mouseup äº‹ä»¶ã€‚è¿™æ˜¯è§¦æ‘¸æ“ä½œçš„ç»“æŸæ ‡å¿—ã€‚ â€¢
    ç»‘å®šçš„å‡½æ•°ï¼šhandleTouchEndï¼šå½“è§¦æ‘¸ç»“æŸæ—¶ï¼Œè°ƒç”¨ handleTouchEnd å‡½æ•°ã€‚é€šå¸¸ç”¨äºåœ¨æ»‘åŠ¨æ“ä½œç»“æŸåè¿›è¡ŒæŸäº›å¤„ç†ï¼Œæ¯”å¦‚è§¦å‘åˆ·æ–°æ“ä½œæˆ–è€…é‡ç½®ä¸‹æ‹‰çš„ç•Œé¢çŠ¶æ€
    @touchend="handleTouchEnd"ï¼š
	â€¢	touchend äº‹ä»¶ï¼šå½“ç”¨æˆ·æ‰‹æŒ‡ç¦»å¼€å±å¹•æ—¶è§¦å‘ï¼Œç›¸å½“äºé¼ æ ‡çš„ mouseup äº‹ä»¶ã€‚è¿™æ˜¯è§¦æ‘¸æ“ä½œçš„ç»“æŸæ ‡å¿—ã€‚
	â€¢	ç»‘å®šçš„å‡½æ•°ï¼šhandleTouchEndï¼šå½“è§¦æ‘¸ç»“æŸæ—¶ï¼Œè°ƒç”¨ handleTouchEnd å‡½æ•°ã€‚é€šå¸¸ç”¨äºåœ¨æ»‘åŠ¨æ“ä½œç»“æŸåè¿›è¡ŒæŸäº›å¤„ç†ï¼Œæ¯”å¦‚è§¦å‘åˆ·æ–°æ“ä½œæˆ–è€…é‡ç½®ä¸‹æ‹‰çš„ç•Œé¢çŠ¶æ€
    -->
  <!-- touchstart æ‰‹æŒ‡è§¦æ‘¸å±å¹•å¼€å§‹è§¦å‘    touchmove æ‰‹æŒ‡è§¦æ‘¸å±å¹•è¿ç»­è§¦å‘   touchend æ‰‹æŒ‡è§¦æ‘¸å±å¹•ç»“æŸè§¦å‘ -->
  <div class="pull-to-refresh" @touchstart="handleTouchStart" @touchmove="handleTouchMove" @touchend="handleTouchEnd">
    <!-- ä¸‹æ‹‰åˆ·æ–°æç¤ºåŒºåŸŸ -->
    <!-- è®¾ç½®ä¸‹æ‹‰åŠ è½½æç¤ºåŒºåŸŸ -->
    <!-- åˆ·æ–°é«˜åº¦å¤§äº0é‚£ä¹ˆå°±æ˜¯å¼€å§‹ä¸‹æ‹‰åˆ·æ–°  è¿›å…¥åˆ·æ–°ä¸­ -->
    <div class="refresh-header" :style="{ height: `${refreshHeight}px` }">
      <div v-if="isRefreshing">åˆ·æ–°ä¸­...</div>
      <div v-else-if="refreshHeight > 0">ä¸‹æ‹‰åˆ·æ–°</div>
    </div>
    <!-- åˆ—è¡¨å†…å®¹åŒºåŸŸ -->
    <div class="content">
      <div v-for="item in items" :key="item.id" class="item">
        {{ item.text }}
      </div>
    </div>
  </div>
</template>

<script>
import { ref } from "vue"

export default {
  setup() {
    // å†…å®¹åŠ è½½æ•°æ®
    const items = ref([])
    const refreshHeight = ref(0) // ä¸‹æ‹‰çš„é«˜åº¦
    const isRefreshing = ref(false) // åˆ·æ–°çŠ¶æ€
    const startY = ref(0) // è§¦æ‘¸å¼€å§‹çš„ä½ç½®
    const maxPullDownHeight = 100 // æœ€å¤§ä¸‹æ‹‰é«˜åº¦
    const isPullingDown = ref(false) // æ˜¯å¦åœ¨ä¸‹æ‹‰

    // æ¨¡æ‹ŸåŠ è½½æ•°æ®
    const loadData = () => {
      items.value = Array.from({ length: 10 }, (_, index) => ({
        id: index,
        text: `Item ${index + 1}`,
      }))
    }

    // å¤„ç†è§¦æ‘¸å¼€å§‹
    const handleTouchStart = (event) => {
      console.log("ğŸš€ ~ handleTouchStart ~ event:", event)
      if (window.scrollY === 0) {
        //ä»é¡¶éƒ¨å¼€å§‹
        // ä»…åœ¨é¡µé¢æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶è®°å½•è§¦æ‘¸ç‚¹
        startY.value = event.touches[0].clientY //å½“å‰çš„ä¸‹æ‹‰åˆ·æ–°çš„
        // å¼€å§‹è¿›è¡Œä¸‹æ‹‰åˆ·æ–°
        isPullingDown.value = true
      }
    }

    // window.scrollY æ˜¯ä¸€ä¸ª JavaScript å±æ€§ï¼Œå®ƒè¿”å›å½“å‰é¡µé¢å‚ç›´æ–¹å‘ï¼ˆY è½´ï¼‰ä¸Šå·²ç»æ»šåŠ¨çš„åƒç´ å€¼ã€‚

    // è¯¦ç»†è§£é‡Šï¼š

    // 	â€¢	window.scrollY è¡¨ç¤ºé¡µé¢ä»é¡¶éƒ¨å‘ä¸‹æ»šåŠ¨çš„è·ç¦»ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚
    // 	â€¢	å½“é¡µé¢å†…å®¹è¶…è¿‡å¯è§†çª—å£æ—¶ï¼Œç”¨æˆ·å¯ä»¥ä¸Šä¸‹æ»šåŠ¨é¡µé¢ã€‚window.scrollY å°±ä¼šåæ˜ å‡ºé¡µé¢å·²ç»æ»šåŠ¨äº†å¤šå°‘è·ç¦»ã€‚
    // 	â€¢	å¦‚æœé¡µé¢æ²¡æœ‰æ»šåŠ¨ï¼Œwindow.scrollY çš„å€¼ä¸º 0ã€‚
    // 	â€¢	è¿™ä¸ªå±æ€§æ˜¯åªè¯»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½ç›´æ¥é€šè¿‡ä¿®æ”¹ window.scrollY æ¥æ”¹å˜é¡µé¢æ»šåŠ¨ä½ç½®ï¼Œä½†å¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•ï¼ˆä¾‹å¦‚ window.scrollTo()ï¼‰æ¥æ§åˆ¶é¡µé¢æ»šåŠ¨ã€‚

    // åº”ç”¨åœºæ™¯ï¼š

    // 	1.	åˆ¤æ–­é¡µé¢æ»šåŠ¨ä½ç½®ï¼š
    // 	â€¢	å¯ä»¥é€šè¿‡ window.scrollY === 0 åˆ¤æ–­é¡µé¢æ˜¯å¦åœ¨é¡¶éƒ¨ã€‚
    // 	â€¢	åœ¨å®ç°ä¸€äº›æ»šåŠ¨è§¦å‘çš„æ•ˆæœï¼ˆå¦‚æ˜¾ç¤º/éšè—æŒ‰é’®ã€å›ºå®šå¯¼èˆªæ ç­‰ï¼‰æ—¶éå¸¸æœ‰ç”¨ã€‚
    // 	2.	å®ç°ä¸‹æ‹‰åˆ·æ–°ï¼š
    // 	â€¢	åœ¨å®ç°ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½æ—¶ï¼Œä½ å¯ä»¥é€šè¿‡æ£€æŸ¥ window.scrollY æ˜¯å¦ä¸º 0 æ¥ç¡®è®¤ç”¨æˆ·æ˜¯å¦åœ¨é¡µé¢é¡¶éƒ¨å¼€å§‹ä¸‹æ‹‰ã€‚åªæœ‰å½“é¡µé¢ä½äºé¡¶éƒ¨æ—¶ï¼Œæ‰èƒ½è§¦å‘ä¸‹æ‹‰åˆ·æ–°æ“ä½œã€‚

    // å¤„ç†è§¦æ‘¸ç§»åŠ¨
    const handleTouchMove = (event) => {
      console.log("ğŸš€ ~ handleTouchMove ~ event:", event) // å¦‚æœä¸‹æ‹‰çš„è·ç¦»æ¶ˆå¤±å°±ä¸è¿›è¡Œä¸‹æ‹‰åˆ·æ–°
      if (!isPullingDown.value || isRefreshing.value) return
      // å½“å‰ä¸‹æ‹‰åˆ·æ–°çš„è·ç¦»
      const currentY = event.touches[0].clientY
      //  å½“å‰çš„çš„è·ç¦»å’Œå¼€å§‹å·®å€¼
      const diff = currentY - startY.value

      if (diff > 0) {
        // ä»…åœ¨å‘ä¸‹æ»‘åŠ¨æ—¶æ›´æ–°é«˜åº¦
        refreshHeight.value = Math.min(diff, maxPullDownHeight)
      }
    }

    // å¤„ç†è§¦æ‘¸ç»“æŸ
    const handleTouchEnd = () => {
      if (!isPullingDown.value) return

      isPullingDown.value = false

      if (refreshHeight.value === maxPullDownHeight) {
        startRefresh()
      } else {
        refreshHeight.value = 0 // æœªè¾¾åˆ°é˜ˆå€¼æ—¶æ¢å¤åˆå§‹çŠ¶æ€
      }
    }

    // æ‰§è¡Œåˆ·æ–°æ“ä½œ
    const startRefresh = () => {
      isRefreshing.value = true

      // æ¨¡æ‹Ÿåˆ·æ–°æ“ä½œ
      setTimeout(() => {
        isRefreshing.value = false
        refreshHeight.value = 0 // åˆ·æ–°å®Œæˆåé‡ç½®ä¸‹æ‹‰é«˜åº¦
        loadData() // æ¨¡æ‹Ÿé‡æ–°åŠ è½½æ•°æ®
      }, 2000)
    }

    loadData() // åˆå§‹åŠ è½½æ•°æ®

    return {
      items,
      refreshHeight,
      isRefreshing,
      handleTouchStart,
      handleTouchMove,
      handleTouchEnd,
    }
  },
}
</script>

<style scoped>
.pull-to-refresh {
  position: relative;
  overflow-y: auto;
  height: 100vh; /* è®¾ç½®å…¨å±é«˜åº¦ */
}

.refresh-header {
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: #e0f7fa;
  color: #00796b;
  font-size: 16px;
  transition: height 0.3s ease;
}

.content {
  padding: 20px;
}

.item {
  background-color: #f0f0f0;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 5px;
}
</style>
